name: CI Petite Maison DevSecOps Dev

on:
  push:
    branches: [ dev ]

jobs:
  # ==========================================================
  # JOB BACKEND : Validation de la logique API-
  # ==========================================================
  backend-validation:
    name: Validation Backend
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: petite_maison_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Initialize Database Schema
        run: |
          PGPASSWORD=password psql -h localhost -U user -d petite_maison_db -f backend/api-service/init.sql

      - name: 2, 3. Install & Linting Backend
        run: |
          cd backend/api-service
          npm ci
          npm run lint

      - name: 4, 5. Tests Unitaires & Intégration Backend
        run: |
          cd backend/api-service
          npm test -- --coverage --watchAll=false
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_USER: user
          DB_PASSWORD: password
          DB_NAME: petite_maison_db
          JWT_SECRET: "test_secret_pour_ci"
          JWT_REFRESH_SECRET: "refresh_test_secret_pour_ci"

      - name: Export Backend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/api-service/coverage/lcov.info

  # ==========================================================
  # JOB FRONTEND : Validation de l'interface utilisateur
  # ==========================================================
  frontend-validation:
    name: Validation Frontend
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: 2, 3. Install & Linting Frontend
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npm run lint --if-present

      - name: 4, 5. Tests Unitaires & Intégration Frontend
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false --ci --maxWorkers=2
        env:
          CI: true

      - name: Export Frontend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/lcov.info

  # ==========================================================
  # JOB QUALITÉ & LIVRAISON : Scan et Conteneurisation (Fullstack)
  # ==========================================================
  quality-and-delivery:
    name: Qualité, Build & Sécurité
    needs: [backend-validation, frontend-validation]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: 6. SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.javascript.lcov.reportPaths=reports/backend-coverage/lcov.info,reports/frontend-coverage/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.js,**/*.css,**/*.scss,**/__mocks__/**
            -Dsonar.exclusions=frontend/src/reportWebVitals.js,backend/api-service/src/config/database.js,frontend/src/index.js,frontend/src/App.js,frontend/src/setupTests.js,frontend/src/config.js,backend/api-service/src/admin/**,frontend/src/components/Navbar.js,frontend/src/components/Footer.js,backend/api-service/src/app.js,**/package-lock.json

      # ÉTAPE 7 : Build Image (Docker)
      # Correction : utilisation d'un tag unique basé sur le commit SHA
      - name: 7. Build Backend & Frontend Images
        run: |
          BACK_ID=$(echo "ghcr.io/${{ github.repository }}/backend:${{ github.sha }}" | tr '[:upper:]' '[:lower:]')
          docker build -t $BACK_ID ./backend/api-service
          echo "BACK_IMAGE=$BACK_ID" >> $GITHUB_ENV
          
          FRONT_ID=$(echo "ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}" | tr '[:upper:]' '[:lower:]')
          docker build -t $FRONT_ID ./frontend
          echo "FRONT_IMAGE=$FRONT_ID" >> $GITHUB_ENV

      - name: 8. Scan Images with Trivy
        run: |
          docker run -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity CRITICAL,HIGH --format table ${{ env.BACK_IMAGE }}
          docker run -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity CRITICAL,HIGH --format table ${{ env.FRONT_IMAGE }}

      # ÉTAPE 9 : Push Registry (GHCR.io)
      # Correction : push des images taggées avec le SHA
      - name: 9. Login & Push to Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ${{ env.BACK_IMAGE }}
          docker push ${{ env.FRONT_IMAGE }}

name: üöÄ CD - Deploy to OpenShift

# Ëß¶ÂèëÂô® (Trigger) : Le d√©ploiement se lance apr√®s la r√©ussite de la CI
on:
  workflow_run:
    workflows: ["üõ†Ô∏è CI - Test & Build"] # Doit correspondre EXACTEMENT au 'name' de ta CI
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # üîó √âTAPE DE CONTR√îLE : Lie ce job √† l'environnement 'production' sur GitHub
    # R√¥le : Active le bouton d'approbation manuelle (Approval Gate) pour le Lead Dev.
    environment: production 

    # ‚úÖ Condition de s√©curit√© : On ne d√©ploie que si les tests CI sont au vert
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # --- √âTAPE 1 : R√âCUP√âRATION DU CODE ---
      # Technologie : GitHub Actions
      # R√¥le : R√©cup√®re les Helm Charts et les fichiers de configuration (Infrastructure as Code)
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # --- √âTAPE 2 : V√âRIFICATION DE LA QUALIT√â (TEST STATIQUE) ---
      # Technologie : Helm Lint
      # R√¥le : √âvaluer la qualit√© du d√©veloppement de l'infrastructure avant d√©ploiement
      - name: üîç Helm Chart Lint
        run: |
          helm lint ./charts/petite-maison-troc
          # Emp√™che le d√©ploiement si une erreur de syntaxe ou de conformit√© est d√©tect√©e

      # --- √âTAPE 3 : AUTHENTIFICATION AU CLUSTER CLOUD ---
      # Technologie : RedHat OpenShift (oc login)
      # R√¥le : Connexion s√©curis√©e au bac √† sable (Sandbox) via les secrets GitHub
      - name: üîê Authenticate to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}

      # --- √âTAPE 4 : D√âPLOIEMENT ORCHESTR√â AVEC STRAT√âGIE DE ROLLBACK ---
      # Technologie : Helm upgrade --install
      # R√¥le : Orchestrer la mise en production et garantir la disponibilit√© (Anti-casse)
      - name: üèóÔ∏è Helm Upgrade & Rollback Strategy
        run: |
          helm upgrade petite-maison ./charts/petite-maison-troc \
            --install \
            --atomic \ # üîÑ Active le Rollback automatique si le d√©ploiement √©choue
            --wait \   # ‚è≥ Attend que tous les Pods soient en √©tat 'Ready' (Health Check)
            --timeout 5m0s \
            --set openshift.enabled=true \
            --set frontend.image.tag=latest \
            --set backend.image.tag=latest \
            -f ./charts/petite-maison-troc/values.yaml \
            --set secrets.dbName="petite_maison" \
            --set secrets.dbUser="dev" \
            --set secrets.dbPassword=${{ secrets.DB_PASSWORD }} \
            --set secrets.jwtSecret=${{ secrets.JWT_SECRET }} \
            --set secrets.jwtRefreshSecret=${{ secrets.JWT_REFRESH_SECRET }} \
            --namespace ${{ secrets.OPENSHIFT_NAMESPACE }}

      # --- √âTAPE 5 : SUPERVISION ET OBSERVABILIT√â ---
      # Technologie : OpenShift CLI (oc)
      # R√¥le : V√©rifier l'√©tat des ressources (Pods, Services, Routes) post-d√©ploiement
      - name: ü©∫ Check Pods Status
        run: |
          oc get pods
          oc get services
          oc get routes

      # --- √âTAPE 6 : TEST DE CONNECTIVIT√â FINALE (SMOKE TEST) ---
      # Technologie : Curl / HTTP
      # R√¥le : D√©montrer la faisabilit√© r√©elle du POC via un code retour HTTP 200
      - name: üåê Smoke Test (V√©rification URL HTTPS)
        run: |
          echo "V√©rification de l'acc√®s au Frontend..."
          # Une fois l'URL de ta Route connue, d√©commente la ligne suivante :
          # curl -I -k -s https://votre-route-openshift | grep "200 OK"
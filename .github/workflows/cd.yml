name: üöÄ CD - Deploy to OpenShift

# Ëß¶ÂèëÂô® (Trigger) : Le d√©ploiement se lance apr√®s la r√©ussite de la CI ou manuellement
on:
  # Permet de lancer le d√©ploiement manuellement via l'interface ou la CLI (gh workflow run)
  workflow_dispatch:

  # D√©clenchement automatique apr√®s le succ√®s du workflow de CI
  workflow_run:
    workflows: ["CI Petite Maison DevSecOps"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # üîó √âTAPE DE CONTR√îLE : Lie ce job √† l'environnement 'production'
    # Active la validation manuelle (Approval Gate) sur GitHub pour le Lead Dev.
    environment: production 

    # ‚úÖ Condition de s√©curit√© : On ne d√©ploie que si les tests CI sont valid√©s (Success)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # --- √âTAPE 1 : R√âCUP√âRATION DU CODE ---
      # Technologie : GitHub Actions / Checkout
      # R√¥le : R√©cup√®re les Helm Charts pour l'Infrastructure as Code (IaC).
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # --- √âTAPE 2 : QUALIT√â DE L'INFRASTRUCTURE (LINTING) ---
      # Technologie : Helm Lint
      # R√¥le : Analyse statique des fichiers YAML pour pr√©venir les erreurs de d√©ploiement.
      - name: üîç Helm Chart Lint
        run: |
          helm lint ./charts/petite-maison-troc

      # --- √âTAPE 3 : AUTHENTIFICATION CLOUD (CORRIG√âE) ---
      # Technologie : RedHat OpenShift Login
      # R√¥le : √âtablit une connexion s√©curis√©e avec le cluster via les secrets du d√©p√¥t.
      - name: üîê Authenticate to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          # Correction : Utilisation du param√®tre exact 'openshift_server_url'
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ secrets.OPENSHIFT_NAMESPACE }}

      # --- √âTAPE 4 : D√âPLOIEMENT & STRAT√âGIE ANTI-CASSE ---
      # Technologie : Helm upgrade --install
      # R√¥le : Mise √† jour atomique. Si les Pods ne d√©marrent pas, Helm restaure l'ancienne version.
      - name: üèóÔ∏è Helm Upgrade & Rollback Strategy
        run: |
          helm upgrade petite-maison ./charts/petite-maison-troc \
            --install \
            --atomic \
            --wait \
            --timeout 5m0s \
            --set openshift.enabled=true \
            --set frontend.image.tag=latest \
            --set backend.image.tag=latest \
            -f ./charts/petite-maison-troc/values.yaml \
            --set secrets.dbName="petite_maison" \
            --set secrets.dbUser="dev" \
            --set secrets.dbPassword=${{ secrets.DB_PASSWORD }} \
            --set secrets.jwtSecret=${{ secrets.JWT_SECRET }} \
            --set secrets.jwtRefreshSecret=${{ secrets.JWT_REFRESH_SECRET }} \
            --namespace ${{ secrets.OPENSHIFT_NAMESPACE }}

      # --- √âTAPE 5 : OBSERVABILIT√â POST-D√âPLOIEMENT ---
      # Technologie : OpenShift CLI (oc)
      # R√¥le : Supervision imm√©diate des Pods, Services et Routes cr√©√©s.
      - name: ü©∫ Check Pods Status
        run: |
          oc get pods
          oc get services
          oc get routes

      # --- √âTAPE 6 : VALIDATION FINALE (SMOKE TEST) ---
      # Technologie : Curl / HTTP
      # R√¥le : Prouver la disponibilit√© r√©elle du service via un test de connectivit√©.
      - name: üåê Smoke Test (V√©rification URL)
        run: |
          echo "V√©rification du d√©ploiement..."
          # Une fois la route connue, ce test confirme le code HTTP 200 (Succ√®s)
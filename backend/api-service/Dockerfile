# -----------------------------------------------------------------------------
# ğŸ—ï¸ Ã‰TAPE 1 â€” Installation des dÃ©pendances (sans devDependencies)
# Multiâ€‘stage build : permet dâ€™avoir une image finale plus lÃ©gÃ¨re et plus sÃ»re
# -----------------------------------------------------------------------------
FROM node:20-alpine AS deps

# Dossier de travail interne au conteneur
WORKDIR /app

# Copie uniquement des fichiers de dÃ©pendances
# â†’ Permet de tirer parti du cache Docker
COPY package*.json ./

# Installation des dÃ©pendances de production uniquement
# npm ci = installation dÃ©terministe, plus rapide et plus fiable
RUN npm install --omit=dev


# -----------------------------------------------------------------------------
# ğŸš€ Ã‰TAPE 2 â€” Image finale dâ€™exÃ©cution
# -----------------------------------------------------------------------------
FROM node:20-alpine

# Dossier de travail
WORKDIR /app

# Copie des node_modules installÃ©s dans lâ€™Ã©tape prÃ©cÃ©dente
COPY --from=deps /app/node_modules ./node_modules

# Copie du code source de lâ€™application
COPY . .

# -----------------------------------------------------------------------------
# ğŸ” SÃ‰CURITÃ‰ OPENSHIFT
# OpenShift impose lâ€™exÃ©cution en utilisateur non-root.
# On crÃ©e un utilisateur dÃ©diÃ© avec UID 1001.
# -----------------------------------------------------------------------------
RUN adduser -D -u 1001 appuser

# On passe en utilisateur non-root
USER 1001

# Port exposÃ© par lâ€™API (cohÃ©rent avec app.js et Helm)
EXPOSE 3000

# Commande de dÃ©marrage
CMD ["node", "src/app.js"]

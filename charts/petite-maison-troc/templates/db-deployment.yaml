# ‚úÖ D√âPLOIEMENT DE LA BASE DE DONN√âES (POSTGRESQL)
# G√®re le moteur de base de donn√©es et garantit que les donn√©es sont √©crites sur le disque persistant.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-db
  labels:
    app: postgres
spec:
  # Une base de donn√©es SQL standard ne supporte g√©n√©ralement qu'un seul r√©plica pour √©viter les corruptions de donn√©es.
  replicas: 1 
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: {{ .Values.database.image | default "postgres:16-alpine" }}
          # üîê CONFIGURATION S√âCURIS√âE : R√©cup√©ration des identifiants depuis les Secrets K8s
          env:
            - name: POSTGRES_DB
              valueFrom: { secretKeyRef: { name: {{ .Release.Name }}-secrets, key: postgres-db } }
            - name: POSTGRES_USER
              valueFrom: { secretKeyRef: { name: {{ .Release.Name }}-secrets, key: postgres-user } }
            - name: POSTGRES_PASSWORD
              valueFrom: { secretKeyRef: { name: {{ .Release.Name }}-secrets, key: postgres-password } }
          ports:
            - containerPort: 5432
          
          # üíæ PERSISTANCE : Le dossier de donn√©es de Postgres est li√© au PVC
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
              # Indispensable pour √©viter que Postgres ne cr√©e ses fichiers √† la racine du volume
              subPath: postgres
              
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            # R√©f√©rence au PVC d√©fini dans values.yaml (postgres-pvc)
            claimName: {{ .Values.database.pvcName }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-backend
  labels:
    app: backend
spec:
  replicas: {{ .Values.backend.replicaCount | default 1 }}
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      # üîê Indispensable pour r√©cup√©rer tes images sur GitHub Packages
      imagePullSecrets:
        - name: ghcr-secret

      # üîí S√©curit√© OpenShift : On force le mode non-root sans fixer l'UID
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: api
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
          imagePullPolicy: {{ .Values.backend.pullPolicy | default "Always" }}
          
          # üîí Interdit l'√©l√©vation de privil√®ges (requis par OpenShift)
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

          ports:
            - containerPort: {{ .Values.backend.containerPort }}

          # üìÅ Volume pour les images t√©l√©charg√©es
          volumeMounts:
            - name: storage-uploads
              mountPath: /app/uploads

          # üîê Injection des secrets et configurations
          env:
            # --- Connexion Supabase (Granulaire) ---
            - name: DB_HOST
              value: {{ .Values.database.host | quote }}
            - name: DB_PORT
              value: {{ .Values.database.port | quote }}
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbName
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbUser
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbPassword

            # --- AJOUT : URL COMPL√àTE (Optimale pour le Pooler 6543) ---
            # C'est cette variable qui g√®re l'encodage du @ et du !
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbUrl

            # --- Configuration Applicative ---
            - name: PORT
              value: {{ .Values.backend.containerPort | quote }}
            - name: FRONTEND_URL
              value: {{ .Values.frontend.url | quote }}

            # --- Secrets JWT ---
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: jwtSecret
            - name: JWT_REFRESH_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: jwtRefreshSecret

      # üíæ D√©finition du volume de stockage
      volumes:
        - name: storage-uploads
          persistentVolumeClaim:
            claimName: {{ .Values.storage.pvcName }}
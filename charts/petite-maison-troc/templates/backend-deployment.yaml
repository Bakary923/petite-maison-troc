apiVersion: apps/v1
kind: Deployment
metadata:
  # Nom unique pour le backend
  name: {{ .Release.Name }}-backend
  labels:
    app: backend
spec:
  # Nombre de r√©pliques (Pods) √† lancer
  replicas: {{ .Values.backend.replicaCount | default 1 }}

  # --- üöÄ STRAT√âGIE DE D√âPLOIEMENT ---
  # Recreate est obligatoire pour lib√©rer le volume PVC (ReadWriteOnce) avant de relancer le nouveau Pod.
  strategy:
    type: Recreate
    rollingUpdate: null # üí° Correction CD : Nettoie les anciens param√®tres pour √©viter l'erreur "Forbidden"
  
  selector:
    matchLabels:
      app: backend

  template:
    metadata:
      labels:
        app: backend
    spec:
      # üîê Secret pour s'authentifier sur la registry GitHub (GHCR.io)
      imagePullSecrets:
        - name: ghcr-secret

      # üîí S√©curit√© du Pod : Standard OpenShift (non-root)
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: api
          # Image construite par la CI avec le tag SHA unique
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
          imagePullPolicy: {{ .Values.backend.pullPolicy | default "Always" }}
          
          # üîí S√©curit√© du Container : Retrait des privil√®ges
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

          # Port d'√©coute de l'API (align√© sur app.js)
          ports:
            - containerPort: {{ .Values.backend.containerPort | default 3000 }}

          # üìÅ Montage du volume persistant pour les images uploads
          volumeMounts:
            - name: storage-uploads
              mountPath: /app/uploads

          env:
            # --- Variables de connexion Supabase ---
            - name: DB_HOST
              value: {{ .Values.database.host | quote }}
            - name: DB_PORT
              value: {{ .Values.database.port | quote }}
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbName
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbUser
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbPassword
            
            # ‚õìÔ∏è DATABASE_URL : Utilis√©e par database.js pour le Pooler (port 6543)
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: dbUrl

            # --- R√©seau & S√©curit√© ---
            - name: PORT
              value: {{ .Values.backend.containerPort | default 3000 | quote }}
            - name: FRONTEND_URL
              value: {{ .Values.frontend.url | quote }}
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: jwtSecret
            - name: JWT_REFRESH_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secrets
                  key: jwtRefreshSecret

      # üíæ D√©finition du volume persistant (PVC)
      volumes:
        - name: storage-uploads
          persistentVolumeClaim:
            claimName: {{ .Values.storage.pvcName }}
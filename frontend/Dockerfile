# -----------------------------------------------------------------------------
# üèóÔ∏è √âTAPE 1 ‚Äî Build du frontend React
# -----------------------------------------------------------------------------
FROM node:20-alpine AS build

WORKDIR /app

COPY package*.json ./

# Installation des d√©pendances (incluant @supabase/supabase-js)
RUN npm install

COPY . .

# ‚úÖ S√âCURIT√â : D√©claration des arguments de build
# Ces variables seront pass√©es par GitHub Actions de mani√®re s√©curis√©e
ARG REACT_APP_SUPABASE_URL
ARG REACT_APP_SUPABASE_KEY
ARG REACT_APP_API_URL

# ‚úÖ INJECTION : On les transforme en variables d'environnement 
# pour que le compilateur React (webpack) puisse les int√©grer au build
ENV REACT_APP_SUPABASE_URL=$REACT_APP_SUPABASE_URL
ENV REACT_APP_SUPABASE_KEY=$REACT_APP_SUPABASE_KEY
ENV REACT_APP_API_URL=$REACT_APP_API_URL

# Maintenant, React verra bien les cl√©s dans process.env
RUN npm run build


# -----------------------------------------------------------------------------
# üöÄ √âTAPE 2 ‚Äî Serveur Nginx pour servir le build
# -----------------------------------------------------------------------------
FROM nginx:alpine

COPY nginx.conf /etc/nginx/conf.d/default.conf

# R√©cup√©ration du build de l'√©tape pr√©c√©dente
COPY --from=build /app/build /usr/share/nginx/html

# üîê S√âCURIT√â OPENSHIFT (User non-root)
USER 1001

EXPOSE 8080

CMD ["nginx", "-g", "daemon off;"]
# -----------------------------------------------------------------------------
# üèóÔ∏è √âTAPE 1 ‚Äî Build du frontend React
# -----------------------------------------------------------------------------
FROM node:20-alpine AS build

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# -----------------------------------------------------------------------------
# üîê VARIABLES D‚ÄôENVIRONNEMENT POUR LE BUILD REACT
# -----------------------------------------------------------------------------

# üëâ API backend (OpenShift)
ARG REACT_APP_API_URL
ENV REACT_APP_API_URL=$REACT_APP_API_URL

# üëâ Cloudinary (upload images)
ARG REACT_APP_CLOUDINARY_CLOUD_NAME
ARG REACT_APP_CLOUDINARY_UPLOAD_PRESET

ENV REACT_APP_CLOUDINARY_CLOUD_NAME=$REACT_APP_CLOUDINARY_CLOUD_NAME
ENV REACT_APP_CLOUDINARY_UPLOAD_PRESET=$REACT_APP_CLOUDINARY_UPLOAD_PRESET

# ‚ùå Supabase supprim√© (plus utilis√©)
# ARG REACT_APP_SUPABASE_URL
# ARG REACT_APP_SUPABASE_KEY
# ENV REACT_APP_SUPABASE_URL=$REACT_APP_SUPABASE_URL
# ENV REACT_APP_SUPABASE_KEY=$REACT_APP_SUPABASE_KEY

# Build final
RUN npm run build

# -----------------------------------------------------------------------------
# üöÄ √âTAPE 2 ‚Äî Serveur Nginx pour servir le build
# -----------------------------------------------------------------------------
FROM nginx:alpine

COPY nginx.conf /etc/nginx/conf.d/default.conf

COPY --from=build /app/build /usr/share/nginx/html

# üîê OpenShift : user non-root
USER 1001

EXPOSE 8080

CMD ["nginx", "-g", "daemon off;"]

# -----------------------------------------------------------------------------
# üèóÔ∏è √âTAPE 1 ‚Äî Build du frontend React
# -----------------------------------------------------------------------------
FROM node:20-alpine AS build

# Dossier de travail
WORKDIR /app

# Copie des fichiers de d√©pendances
COPY package*.json ./

# Installation d√©terministe des d√©pendances
RUN npm install

# Copie du reste du code source
COPY . .

# Build de l‚Äôapplication React (g√©n√®re le dossier /build)
RUN npm run build


# -----------------------------------------------------------------------------
# üöÄ √âTAPE 2 ‚Äî Serveur Nginx pour servir le build
# -----------------------------------------------------------------------------
FROM nginx:alpine

# Copie de la configuration Nginx personnalis√©e
# (port 8080, redirections, cache, gzip, etc.)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copie du build React dans le dossier public de Nginx
COPY --from=build /app/build /usr/share/nginx/html

# -----------------------------------------------------------------------------
# üîê S√âCURIT√â OPENSHIFT
# Nginx tourne en utilisateur non-root (UID 1001)
# -----------------------------------------------------------------------------
USER 1001

# Port expos√© (coh√©rent avec Helm et OpenShift)
EXPOSE 8080

# Commande de d√©marrage Nginx
CMD ["nginx", "-g", "daemon off;"]
